<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Service Marketing Priority Hub</title>
    <!--
    USAGE:
    - Edit Mode (Admin): Add ?edit=true to the URL - you can add/edit/delete tasks
      Example: https://yoursite.github.io/marketing-hub/?edit=true
    
    - View Mode (Team): Regular URL - read-only for viewing
      Example: https://yoursite.github.io/marketing-hub/
      
    Embed the View Mode URL in Outline for your team to see updates.
    Bookmark the Edit Mode URL to make changes.
    -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1d1d1f;
            --primary-light: #6e6e73;
            --accent: #0071e3;
            --accent-hover: #0077ed;
            --bg: #fbfbfd;
            --surface: #ffffff;
            --text: #1d1d1f;
            --text-secondary: #86868b;
            --border: #d2d2d7;
            --shadow: rgba(0, 0, 0, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.5;
            min-height: 100vh;
            padding: 3rem 2rem;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        header {
            margin-bottom: 2.5rem;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--text);
            font-weight: 600;
            letter-spacing: -0.03em;
        }

        .toolbar {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.625rem 1.25rem;
            border-radius: 980px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            font-weight: 500;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 113, 227, 0.3);
        }

        .btn-secondary {
            background: var(--surface);
            color: var(--text);
            border: 1px solid var(--border);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .btn-secondary:hover {
            background: var(--bg);
            border-color: var(--text-secondary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .filter-group {
            display: flex;
            gap: 0.5rem;
            background: var(--surface);
            padding: 0.25rem;
            border-radius: 980px;
            border: 1px solid var(--border);
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            font-size: 0.8125rem;
            font-weight: 500;
            color: var(--text-secondary);
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: var(--text);
            color: white;
        }

        .filter-btn:hover:not(.active) {
            color: var(--text);
        }

        .priorities-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .priority-card {
            background: var(--surface);
            border-radius: 18px;
            padding: 0;
            border: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
            animation: slideIn 0.4s ease-out;
            animation-fill-mode: both;
            overflow: hidden;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .priority-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
            border-color: var(--text-secondary);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 2rem;
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            gap: 1.5rem;
        }

        .card-title-section {
            flex: 1;
        }

        .department-tag {
            display: inline-block;
            font-size: 0.6875rem;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .card-title {
            font-size: 1.75rem;
            color: var(--text);
            line-height: 1.2;
            margin-bottom: 0.5rem;
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .status-badge {
            padding: 0.375rem 0.875rem;
            border-radius: 980px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        .status-not-started { background: #f5f5f7; color: var(--text-secondary); }
        .status-in-progress { background: #fff4e6; color: #f56300; }
        .status-blocked { background: #ffebee; color: #d32f2f; }
        .status-completed { background: #e8f5e9; color: #34c759; }

        .card-description {
            color: var(--text-secondary);
            font-size: 0.9375rem;
            font-weight: 400;
        }

        .card-body {
            padding: 2rem;
        }

        .card-section {
            margin-bottom: 2rem;
        }

        .card-section:last-child {
            margin-bottom: 0;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 0.8125rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .add-update-btn {
            padding: 0.4rem 0.875rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 980px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .add-update-btn:hover {
            background: var(--accent-hover);
            transform: scale(1.02);
        }

        .updates-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .update-item {
            background: var(--bg);
            padding: 1rem 1.25rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            position: relative;
        }

        .update-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .update-date {
            font-size: 0.8125rem;
            color: var(--accent);
            font-weight: 600;
        }

        .update-text {
            font-size: 0.9375rem;
            color: var(--text);
            line-height: 1.5;
        }

        .delete-update-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            padding: 0.25rem;
            line-height: 1;
            transition: color 0.2s ease;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-update-btn:hover {
            color: #ff3b30;
            background: rgba(255, 59, 48, 0.1);
        }

        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 1rem;
        }

        .image-item {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg);
            border: 1px solid var(--border);
            aspect-ratio: 16/9;
        }

        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .image-item .delete-image-btn {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.2s ease;
        }

        .image-item:hover .delete-image-btn {
            opacity: 1;
        }

        .image-item .delete-image-btn:hover {
            background: rgba(255, 59, 48, 0.9);
        }

        .add-image-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg);
            aspect-ratio: 16/9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-image-area:hover {
            border-color: var(--accent);
            background: var(--surface);
        }

        .add-image-area input {
            display: none;
        }

        .add-image-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
            font-weight: 500;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 0.5rem;
        }

        .link-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 0.875rem;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .link-item:hover {
            background: var(--surface);
            border-color: var(--text-secondary);
        }

        .link-item a {
            color: var(--accent);
            text-decoration: none;
            transition: color 0.2s ease;
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: 500;
        }

        .link-item a:hover {
            color: var(--accent-hover);
        }

        .notes-display {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid var(--border);
            font-size: 0.9375rem;
            color: var(--text);
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .empty-state-small {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .update-images {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .update-image {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            aspect-ratio: 4/3;
            cursor: pointer;
        }

        .update-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .analytics-section {
            background: var(--bg);
            padding: 1.25rem;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .analytics-chart {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .metric-card {
            background: var(--surface);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border);
        }

        .metric-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--text);
            letter-spacing: -0.02em;
        }

        .metric-change {
            font-size: 0.8125rem;
            margin-top: 0.25rem;
        }

        .metric-change.positive {
            color: #34c759;
        }

        .metric-change.negative {
            color: #ff3b30;
        }

        .analytics-log {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .analytics-entry {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }

        .analytics-entry:last-child {
            border-bottom: none;
        }

        .analytics-entry-date {
            color: var(--accent);
            font-weight: 600;
        }

        .analytics-entry-values {
            display: flex;
            gap: 1.5rem;
        }

        .analytics-entry-value {
            color: var(--text-secondary);
        }

        .analytics-entry-value strong {
            color: var(--text);
            margin-left: 0.25rem;
        }

        .card-actions {
            display: flex;
            gap: 0.5rem;
            padding: 1.25rem 2rem;
            border-top: 1px solid var(--border);
            background: var(--bg);
        }

        .action-btn {
            padding: 0.5rem 1.125rem;
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 980px;
            cursor: pointer;
            font-size: 0.8125rem;
            transition: all 0.2s ease;
            color: var(--text);
            font-weight: 500;
        }

        .action-btn:hover {
            background: var(--text);
            color: white;
            border-color: var(--text);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: var(--surface);
            padding: 2rem;
            border-radius: 18px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        .modal-content.small {
            max-width: 450px;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.5rem;
            color: var(--text);
            font-weight: 600;
            letter-spacing: -0.02em;
        }

        .close-btn {
            background: var(--bg);
            border: 1px solid var(--border);
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-secondary);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: var(--text);
            color: white;
            border-color: var(--text);
        }

        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text);
            font-size: 0.875rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 0.9375rem;
            transition: all 0.2s ease;
            background: var(--surface);
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            color: var(--text);
            font-weight: 600;
        }

        @media (max-width: 768px) {
            body {
                padding: 2rem 1rem;
            }

            h1 {
                font-size: 2rem;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-group {
                justify-content: center;
            }

            .card-title {
                font-size: 1.5rem;
            }

            .images-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }

        /* View-only mode styles */
        body.view-only .toolbar,
        body.view-only .add-update-btn,
        body.view-only .delete-update-btn,
        body.view-only .card-actions {
            display: none;
        }

        body.view-only header::after {
            content: '(View Only)';
            display: block;
            font-size: 0.875rem;
            color: var(--text-secondary);
            font-weight: 400;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Phone Service Marketing Priority Hub</h1>
        </header>

        <div class="toolbar">
            <button class="btn" id="addTaskBtn">+ Add Task</button>
            <button class="btn btn-secondary" id="exportBtn">Export Data</button>
            <div class="filter-group">
                <button class="filter-btn active" data-filter="all">All</button>
                <button class="filter-btn" data-filter="in-progress">In Progress</button>
                <button class="filter-btn" data-filter="blocked">Blocked</button>
                <button class="filter-btn" data-filter="completed">Completed</button>
            </div>
        </div>

        <div id="prioritiesContainer" class="priorities-grid">
            <div class="loading">Loading your tasks...</div>
        </div>
    </div>

    <!-- Quick Update Modal -->
    <div id="updateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Weekly Update</h2>
                <button class="close-btn" onclick="closeUpdateModal()">Ã—</button>
            </div>
            <form id="updateForm" onsubmit="saveUpdate(event)">
                <div class="form-group">
                    <label for="updateDate">Date *</label>
                    <input type="date" id="updateDate" required>
                </div>
                <div class="form-group">
                    <label for="updateText">Update *</label>
                    <textarea id="updateText" required placeholder="Describe what progress was made this week..." rows="4"></textarea>
                </div>
                <div class="form-group">
                    <label for="updateImages">Images (optional)</label>
                    <input type="file" id="updateImages" accept="image/*" multiple style="display: block; padding: 0.5rem 0; border: none;">
                    <small style="color: var(--text-secondary); font-size: 0.8125rem;">You can select multiple images</small>
                </div>
                <button type="submit" class="btn" style="width: 100%;">Add Update</button>
            </form>
        </div>
    </div>

    <!-- Analytics Modal -->
    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Log Analytics</h2>
                <button class="close-btn" onclick="closeAnalyticsModal()">Ã—</button>
            </div>
            <form id="analyticsForm" onsubmit="saveAnalytics(event)">
                <div class="form-group">
                    <label for="analyticsDate">Date *</label>
                    <input type="date" id="analyticsDate" required>
                </div>
                <div id="analyticsFields"></div>
                <button type="submit" class="btn" style="width: 100%;">Save Analytics</button>
            </form>
        </div>
    </div>

    <!-- Add/Edit Modal -->
    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Task</h2>
                <button class="close-btn" onclick="closeModal()">Ã—</button>
            </div>
            <form id="priorityForm" onsubmit="savePriority(event)">
                <div class="form-group">
                    <label for="department">Department *</label>
                    <input type="text" id="department" required placeholder="e.g., Design, Content, Social Media">
                </div>
                <div class="form-group">
                    <label for="title">Task Title *</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Task Description</label>
                    <textarea id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="status">Status *</label>
                    <select id="status" required>
                        <option value="not-started">Not Started</option>
                        <option value="in-progress">In Progress</option>
                        <option value="blocked">Blocked</option>
                        <option value="completed">Completed</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskLinks">Relevant Links (one per line, format: Title | URL)</label>
                    <textarea id="taskLinks" placeholder="Design File | https://figma.com/file/123&#10;Project Brief | https://docs.google.com/doc/456"></textarea>
                </div>
                <div class="form-group">
                    <label for="notes">Additional Notes</label>
                    <textarea id="notes"></textarea>
                </div>
                
                <!-- Analytics Tracking Section -->
                <div class="form-group" style="border-top: 1px solid var(--border); padding-top: 1.5rem; margin-top: 1.5rem;">
                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                        <input type="checkbox" id="enableAnalytics" onchange="toggleAnalyticsFields()" style="width: auto; cursor: pointer;">
                        <span>Enable Analytics Tracking</span>
                    </label>
                    <small style="color: var(--text-secondary); font-size: 0.8125rem; display: block; margin-top: 0.5rem;">Track metrics like impressions, clicks, conversions, etc.</small>
                </div>
                
                <div id="analyticsFieldsSetup" style="display: none;">
                    <div class="form-group">
                        <label for="analyticsMetrics">Analytics Metrics (one per line)</label>
                        <textarea id="analyticsMetrics" placeholder="Impressions&#10;Clicks&#10;Conversions&#10;Cost" rows="4"></textarea>
                        <small style="color: var(--text-secondary); font-size: 0.8125rem;">These are the metrics you'll track for this task</small>
                    </div>
                </div>
                
                <button type="submit" class="btn" style="width: 100%;">Save Task</button>
            </form>
        </div>
    </div>

    <script type="module">
        let priorities = [];
        let currentFilter = 'all';
        let editingId = null;
        let currentUpdateTaskId = null;
        let currentAnalyticsTaskId = null;
        let isEditMode = false;

        // Check if in edit mode
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            isEditMode = urlParams.get('edit') === 'true';
            
            if (!isEditMode) {
                // Hide edit controls in view-only mode
                document.body.classList.add('view-only');
            }
        }

        // JSONBin configuration
        const JSONBIN_BIN_ID = '679d8e4aad19ca34f8e66bc8';
        const JSONBIN_API_KEY = '$2a$10$XNb3jzoK4FlalKCEzrL3z.VqE0pDqRGKmGZ0hYqXqI8vEqYqL8bP2';

        // Initialize
        async function init() {
            checkEditMode();
            await loadPriorities();
            renderPriorities();
        }

        // Load priorities from JSONBin
        async function loadPriorities() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': JSONBIN_API_KEY
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    priorities = data.record || [];
                } else if (response.status === 404) {
                    // Bin doesn't exist yet, create it
                    console.log('Bin not found, will create on first save');
                    priorities = [];
                } else {
                    console.error('Error loading:', response.status);
                    priorities = [];
                }
            } catch (error) {
                console.error('Error loading data:', error);
                // If we can't reach JSONBin, try localStorage as fallback
                try {
                    const stored = localStorage.getItem('phone-service-priorities-backup');
                    if (stored) {
                        priorities = JSON.parse(stored);
                        console.log('Loaded from localStorage backup');
                    } else {
                        priorities = [];
                    }
                } catch (e) {
                    priorities = [];
                }
            }
        }

        // Save priorities to JSONBin
        async function savePriorities() {
            if (!isEditMode) {
                alert('You must use the edit URL to make changes.');
                return;
            }

            // Always save to localStorage as backup
            try {
                localStorage.setItem('phone-service-priorities-backup', JSON.stringify(priorities));
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }

            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': JSONBIN_API_KEY
                    },
                    body: JSON.stringify(priorities)
                });

                if (!response.ok) {
                    throw new Error('Failed to save to JSONBin');
                }
                console.log('Data saved to JSONBin successfully');
            } catch (error) {
                console.error('Failed to save priorities to JSONBin:', error);
                alert('Warning: Could not save to cloud. Data saved locally only.');
            }
        }

        // Render priorities
        function renderPriorities() {
            const container = document.getElementById('prioritiesContainer');
            
            let filteredPriorities = priorities;
            if (currentFilter !== 'all') {
                filteredPriorities = priorities.filter(p => p.status === currentFilter);
            }

            if (filteredPriorities.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>No tasks yet</h3>
                        <p>Click "Add Task" to start tracking your marketing initiatives</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredPriorities.map((priority, index) => `
                <div class="priority-card" style="animation-delay: ${index * 0.05}s;">
                    <div class="card-header">
                        <div class="card-title-section">
                            <div class="department-tag">${escapeHtml(priority.department || 'General')}</div>
                            <h3 class="card-title">${escapeHtml(priority.title)}</h3>
                            ${priority.description ? `<p class="card-description">${escapeHtml(priority.description)}</p>` : ''}
                        </div>
                        <span class="status-badge status-${priority.status}">${formatStatus(priority.status)}</span>
                    </div>
                    
                    <div class="card-body">
                        <!-- Weekly Updates Section -->
                        <div class="card-section">
                            <div class="section-header">
                                <h4 class="section-title">Weekly Updates</h4>
                                <button class="add-update-btn" onclick="openUpdateModal('${priority.id}')">+ Add Update</button>
                            </div>
                            ${priority.weeklyProgress && priority.weeklyProgress.length > 0 ? `
                                <div class="updates-list">
                                    ${priority.weeklyProgress.sort((a, b) => new Date(b.date) - new Date(a.date)).map((update, idx) => `
                                        <div class="update-item">
                                            <div class="update-header">
                                                <div class="update-date">${formatDate(update.date)}</div>
                                                <button class="delete-update-btn" onclick="deleteUpdate('${priority.id}', ${idx})" title="Delete update">Ã—</button>
                                            </div>
                                            <div class="update-text">${escapeHtml(update.update)}</div>
                                            ${update.images && update.images.length > 0 ? `
                                                <div class="update-images">
                                                    ${update.images.map(img => `
                                                        <div class="update-image" onclick="openImageModal('${img}')">
                                                            <img src="${img}" alt="Update image">
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div class="empty-state-small">No updates yet. Click "Add Update" to log your weekly progress.</div>
                            `}
                        </div>
                        
                        <!-- Analytics Section -->
                        ${priority.analyticsEnabled ? `
                            <div class="card-section">
                                <div class="analytics-section">
                                    <div class="analytics-header">
                                        <h4 class="section-title">Analytics</h4>
                                        <button class="add-update-btn" onclick="openAnalyticsModal('${priority.id}')">+ Log Data</button>
                                    </div>
                                    ${priority.analyticsData && priority.analyticsData.length > 0 ? `
                                        <div class="analytics-chart">
                                            ${priority.analyticsMetrics.map(metric => {
                                                const latestEntry = priority.analyticsData.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
                                                const previousEntry = priority.analyticsData.sort((a, b) => new Date(b.date) - new Date(a.date))[1];
                                                const currentValue = latestEntry ? latestEntry.values[metric] || 0 : 0;
                                                const previousValue = previousEntry ? previousEntry.values[metric] || 0 : 0;
                                                const change = previousValue !== 0 ? ((currentValue - previousValue) / previousValue * 100).toFixed(1) : 0;
                                                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
                                                return `
                                                    <div class="metric-card">
                                                        <div class="metric-label">${escapeHtml(metric)}</div>
                                                        <div class="metric-value">${formatNumber(currentValue)}</div>
                                                        ${previousEntry ? `<div class="metric-change ${changeClass}">${change > 0 ? 'â†‘' : change < 0 ? 'â†“' : ''} ${Math.abs(change)}%</div>` : ''}
                                                    </div>
                                                `;
                                            }).join('')}
                                        </div>
                                        <details>
                                            <summary style="cursor: pointer; color: var(--accent); font-size: 0.875rem; font-weight: 500;">View all entries</summary>
                                            <div class="analytics-log">
                                                ${priority.analyticsData.sort((a, b) => new Date(b.date) - new Date(a.date)).map(entry => `
                                                    <div class="analytics-entry">
                                                        <div class="analytics-entry-date">${formatDate(entry.date)}</div>
                                                        <div class="analytics-entry-values">
                                                            ${Object.entries(entry.values).map(([key, value]) => `
                                                                <span class="analytics-entry-value">${escapeHtml(key)}: <strong>${formatNumber(value)}</strong></span>
                                                            `).join('')}
                                                        </div>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </details>
                                    ` : `
                                        <div class="empty-state-small">No analytics data yet. Click "Log Data" to start tracking.</div>
                                    `}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Links Section -->
                        ${priority.taskLinks && priority.taskLinks.length > 0 ? `
                            <div class="card-section">
                                <h4 class="section-title">Relevant Links</h4>
                                <div class="links-grid">
                                    ${priority.taskLinks.map(link => `
                                        <div class="link-item">
                                            <span>ðŸ”—</span>
                                            <a href="${escapeHtml(link.url)}" target="_blank">${escapeHtml(link.title)}</a>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Notes Section -->
                        ${priority.notes ? `
                            <div class="card-section">
                                <h4 class="section-title">Notes</h4>
                                <div class="notes-display">${escapeHtml(priority.notes)}</div>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="card-actions">
                        <button class="action-btn" onclick="editPriority('${priority.id}')">Edit Task</button>
                        <button class="action-btn" onclick="deletePriority('${priority.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Handle image upload
        function handleImageUpload(event, taskId) {
            const files = event.target.files;
            const priority = priorities.find(p => p.id === taskId);
            
            if (!priority) return;
            if (!priority.images) priority.images = [];

            Array.from(files).forEach(file => {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    priority.images.push(e.target.result);
                    await savePriorities();
                    renderPriorities();
                };
                reader.readAsDataURL(file);
            });
        }

        // Delete image
        async function deleteImage(taskId, imgIndex) {
            if (!confirm('Are you sure you want to delete this image?')) return;
            
            const priority = priorities.find(p => p.id === taskId);
            if (priority && priority.images) {
                priority.images.splice(imgIndex, 1);
                await savePriorities();
                renderPriorities();
            }
        }

        // Open update modal
        function openUpdateModal(taskId) {
            currentUpdateTaskId = taskId;
            document.getElementById('updateDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('updateText').value = '';
            document.getElementById('updateModal').classList.add('active');
        }

        // Close update modal
        function closeUpdateModal() {
            document.getElementById('updateModal').classList.remove('active');
            currentUpdateTaskId = null;
        }

        // Save update
        async function saveUpdate(event) {
            event.preventDefault();
            
            const date = document.getElementById('updateDate').value;
            const update = document.getElementById('updateText').value;
            const imageFiles = document.getElementById('updateImages').files;
            
            const priority = priorities.find(p => p.id === currentUpdateTaskId);
            if (priority) {
                if (!priority.weeklyProgress) {
                    priority.weeklyProgress = [];
                }
                
                const newUpdate = { date, update, images: [] };
                
                if (imageFiles.length > 0) {
                    let processedImages = 0;
                    Array.from(imageFiles).forEach(file => {
                        const reader = new FileReader();
                        reader.onload = async function(e) {
                            newUpdate.images.push(e.target.result);
                            processedImages++;
                            
                            if (processedImages === imageFiles.length) {
                                priority.weeklyProgress.push(newUpdate);
                                await savePriorities();
                                renderPriorities();
                                closeUpdateModal();
                            }
                        };
                        reader.readAsDataURL(file);
                    });
                } else {
                    priority.weeklyProgress.push(newUpdate);
                    await savePriorities();
                    renderPriorities();
                    closeUpdateModal();
                }
            }
        }

        // Delete update
        async function deleteUpdate(taskId, updateIndex) {
            if (!confirm('Are you sure you want to delete this update?')) return;
            
            const priority = priorities.find(p => p.id === taskId);
            if (priority && priority.weeklyProgress) {
                const sortedUpdates = priority.weeklyProgress.sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedUpdates.splice(updateIndex, 1);
                priority.weeklyProgress = sortedUpdates;
                
                await savePriorities();
                renderPriorities();
            }
        }

        // Open analytics modal
        function openAnalyticsModal(taskId) {
            currentAnalyticsTaskId = taskId;
            const priority = priorities.find(p => p.id === taskId);
            
            if (!priority || !priority.analyticsEnabled) return;
            
            document.getElementById('analyticsDate').value = new Date().toISOString().split('T')[0];
            
            const fieldsContainer = document.getElementById('analyticsFields');
            fieldsContainer.innerHTML = priority.analyticsMetrics.map(metric => `
                <div class="form-group">
                    <label for="metric-${metric.replace(/\s/g, '-')}">${escapeHtml(metric)}</label>
                    <input type="number" id="metric-${metric.replace(/\s/g, '-')}" step="any" placeholder="Enter value">
                </div>
            `).join('');
            
            document.getElementById('analyticsModal').classList.add('active');
        }

        // Close analytics modal
        function closeAnalyticsModal() {
            document.getElementById('analyticsModal').classList.remove('active');
            currentAnalyticsTaskId = null;
        }

        // Save analytics
        async function saveAnalytics(event) {
            event.preventDefault();
            
            const date = document.getElementById('analyticsDate').value;
            const priority = priorities.find(p => p.id === currentAnalyticsTaskId);
            
            if (!priority) return;
            
            const values = {};
            priority.analyticsMetrics.forEach(metric => {
                const input = document.getElementById(`metric-${metric.replace(/\s/g, '-')}`);
                if (input && input.value) {
                    values[metric] = parseFloat(input.value);
                }
            });
            
            if (!priority.analyticsData) {
                priority.analyticsData = [];
            }
            
            priority.analyticsData.push({ date, values });
            
            await savePriorities();
            renderPriorities();
            closeAnalyticsModal();
        }

        // Toggle analytics fields in form
        function toggleAnalyticsFields() {
            const enabled = document.getElementById('enableAnalytics').checked;
            const fieldsSetup = document.getElementById('analyticsFieldsSetup');
            fieldsSetup.style.display = enabled ? 'block' : 'none';
        }

        // Open add modal
        function openAddModal() {
            editingId = null;
            document.getElementById('modalTitle').textContent = 'Add Task';
            document.getElementById('priorityForm').reset();
            document.getElementById('modal').classList.add('active');
        }

        // Edit priority
        function editPriority(id) {
            const priority = priorities.find(p => p.id === id);
            if (!priority) return;

            editingId = id;
            document.getElementById('modalTitle').textContent = 'Edit Task';
            document.getElementById('department').value = priority.department || '';
            document.getElementById('title').value = priority.title;
            document.getElementById('description').value = priority.description || '';
            document.getElementById('status').value = priority.status;
            document.getElementById('taskLinks').value = priority.taskLinks ? 
                priority.taskLinks.map(l => `${l.title} | ${l.url}`).join('\n') : '';
            document.getElementById('notes').value = priority.notes || '';
            
            document.getElementById('enableAnalytics').checked = priority.analyticsEnabled || false;
            toggleAnalyticsFields();
            if (priority.analyticsEnabled && priority.analyticsMetrics) {
                document.getElementById('analyticsMetrics').value = priority.analyticsMetrics.join('\n');
            }
            
            document.getElementById('modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('modal').classList.remove('active');
            editingId = null;
        }

        // Save priority
        async function savePriority(event) {
            event.preventDefault();

            const department = document.getElementById('department').value;
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const status = document.getElementById('status').value;
            const taskLinksText = document.getElementById('taskLinks').value;
            const notes = document.getElementById('notes').value;
            
            const analyticsEnabled = document.getElementById('enableAnalytics').checked;
            const analyticsMetricsText = document.getElementById('analyticsMetrics').value;
            const analyticsMetrics = analyticsEnabled ? analyticsMetricsText.split('\n').filter(m => m.trim()) : [];

            const taskLinks = taskLinksText.split('\n')
                .filter(l => l.trim() && l.includes('|'))
                .map(line => {
                    const [title, url] = line.split('|').map(s => s.trim());
                    return { title, url };
                });

            if (editingId) {
                const priority = priorities.find(p => p.id === editingId);
                if (priority) {
                    priority.department = department;
                    priority.title = title;
                    priority.description = description;
                    priority.status = status;
                    priority.taskLinks = taskLinks;
                    priority.notes = notes;
                    priority.analyticsEnabled = analyticsEnabled;
                    priority.analyticsMetrics = analyticsMetrics;
                    if (!analyticsEnabled) {
                        delete priority.analyticsData;
                    }
                }
            } else {
                const newTask = {
                    id: Date.now().toString(),
                    department,
                    title,
                    description,
                    status,
                    weeklyProgress: [],
                    taskLinks,
                    notes,
                    analyticsEnabled,
                    createdAt: new Date().toISOString()
                };
                
                if (analyticsEnabled) {
                    newTask.analyticsMetrics = analyticsMetrics;
                    newTask.analyticsData = [];
                }
                
                priorities.push(newTask);
            }

            await savePriorities();
            renderPriorities();
            closeModal();
        }

        // Delete priority
        async function deletePriority(id) {
            if (!confirm('Are you sure you want to delete this task?')) return;
            
            priorities = priorities.filter(p => p.id !== id);
            await savePriorities();
            renderPriorities();
        }

        // Filter priorities
        function filterPriorities(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });
            renderPriorities();
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(priorities, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `phone-service-hub-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        // Helper functions
        function formatStatus(status) {
            return status.split('-').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }

        function formatNumber(num) {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toLocaleString();
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openImageModal(src) {
            window.open(src, '_blank');
        }

        // Expose functions to global scope for onclick handlers
        window.openAddModal = openAddModal;
        window.exportData = exportData;
        window.filterPriorities = filterPriorities;
        window.openUpdateModal = openUpdateModal;
        window.deleteUpdate = deleteUpdate;
        window.openAnalyticsModal = openAnalyticsModal;
        window.editPriority = editPriority;
        window.deletePriority = deletePriority;
        window.deleteImage = deleteImage;
        window.openImageModal = openImageModal;
        window.toggleAnalyticsFields = toggleAnalyticsFields;
        window.savePriority = savePriority;
        window.saveUpdate = saveUpdate;
        window.saveAnalytics = saveAnalytics;

        // Set up event listeners
        document.getElementById('addTaskBtn').addEventListener('click', openAddModal);
        document.getElementById('exportBtn').addEventListener('click', exportData);
        
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => filterPriorities(btn.dataset.filter));
        });

        // Close modals on outside click
        document.getElementById('modal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('updateModal').addEventListener('click', function(e) {
            if (e.target === this) closeUpdateModal();
        });

        document.getElementById('analyticsModal').addEventListener('click', function(e) {
            if (e.target === this) closeAnalyticsModal();
        });

        // Initialize on load
        (async function() {
            await init();
        })();
    </script>
</body>
</html>